!function(){"use strict";function e(e,t=66){try{const n=atob(e);let s="";for(let e=0;e<n.length;e++)s+=String.fromCharCode(n.charCodeAt(e)^t);return decodeURIComponent(s)}catch(n){return console.error("Decryption failed:",n),"Decryption Error"}}document.addEventListener("DOMContentLoaded",function(){const t=window.PROBLEM_DATA_LIST;if(!t)return;const n="rny_student_progress_",s={studentId:"",name:"",answers:{},logs:[],savedAt:""};function r(e,t,n){const r={timestamp:(new Date).toISOString(),type:e,message:t,details:n};s.logs.push(r),o(),console.log(`[${r.timestamp}] [${e}] ${t}`,n||"")}function o(e=""){try{localStorage.setItem(n+e,JSON.stringify(s))}catch(t){console.warn("LocalStorage save failed",t)}}function a(){const e=document.querySelectorAll(".problem-container");let t=!1;e.forEach((e,n)=>{var r;const o=e;if(t)return o.classList.add("is-locked"),void i(o);const a=!0===(null==(r=s.answers[n])?void 0:r.isCorrect);o.classList.remove("is-locked"),a?function(e){let t=e.nextElementSibling;for(;t&&!t.classList.contains("problem-container")&&"save-area"!==t.id&&!t.classList.contains("app-footer");)t.classList.remove("is-locked"),t=t.nextElementSibling}(o):(t=!0,i(o))});const n=document.getElementById("save-area");n&&(t?n.classList.add("is-locked"):n.classList.remove("is-locked"))}function i(e){let t=e.nextElementSibling;for(;t;)"save-area"===t.id||t.classList.contains("app-footer")||t.classList.add("is-locked"),t=t.nextElementSibling}r("system","System Initialized",{problemCount:t.length});const c=document.getElementById("answer-drawer"),l=document.getElementById("drawer-toggle"),d=document.getElementById("drawer-list");function u(e,t){if(!d)return;if(document.getElementById(`log-ans-${e}`))return;const n=document.querySelectorAll(".problem-container")[e];let s=`Q:${e+1}`;if(n){const e=n.querySelector(".question-content");e&&e.textContent&&(s=e.textContent.substring(0,40)+(e.textContent.length>40?"...":""))}const r=document.createElement("div");r.className="drawer-item",r.id=`log-ans-${e}`,r.innerHTML=`\n      <div class="drawer-item-q">${s}</div>\n      <div class="drawer-item-a">${t}</div>\n    `,d.appendChild(r),d.scrollTop=d.scrollHeight}l&&c&&l.addEventListener("click",()=>{c.classList.toggle("open")?(document.body.classList.add("drawer-open"),l.textContent="▶ 閉じる"):(document.body.classList.remove("drawer-open"),l.textContent="◀ 解答")}),document.querySelectorAll(".problem-container").forEach(n=>{const i=n.getAttribute("data-index");if(null===i)return;const c=parseInt(i,10),l=t[c],d=n.getAttribute("data-type"),m=n.querySelector(".student-input, .essay-input-text"),g=n.querySelector(".check-btn, .essay-submit-btn"),y=n.querySelector(".result-msg");if(!m||!g||!y)return;const p=(t,n=!1)=>{if("essay"===d)return n||0!==t.length?(y.innerHTML='<span style="color:green">記録しました</span>',m.disabled=!0,g.disabled=!0,g.textContent="記録済み",void(n||(s.answers[c]={userAnswer:t,isCorrect:!0,timestamp:(new Date).toISOString()},r("answer",`Essay ${c+1} submitted`),u(c,"(記述済み)"),a(),o()))):void alert("内容を入力してください");const i=function(e){let t=2166136261;for(let n=0;n<e.length;n++)t^=e.charCodeAt(n),t=Math.imul(t,16777619);return(t>>>0).toString(16)}(t),p=-1!==l.correctHashes.indexOf(i);if(n||r("answer",`Question ${c+1} attempt`,{isCorrect:p}),p){const r=e(l.encryptedText);y.innerHTML=`<span style="color:blue">正解! (${r})</span>`,m.disabled=!0,g.disabled=!0,n||(s.answers[c]={userAnswer:t,isCorrect:!0,timestamp:(new Date).toISOString()},u(c,r),a(),o())}else y.innerHTML='<span style="color:red">不正解</span>',n||(s.answers[c]={userAnswer:t,isCorrect:!1,timestamp:(new Date).toISOString()},o())};g.addEventListener("click",()=>{p(m.value.trim())})});const m=document.getElementById("save-btn"),g=document.getElementById("student-id"),y=document.getElementById("student-name");m&&g&&y&&m.addEventListener("click",()=>{if(s.studentId=g.value,s.name=y.value,s.savedAt=(new Date).toISOString(),!s.studentId||!s.name)return alert("学籍番号と氏名を入力してください"),void r("error","Save attempt failed: Missing ID or Name");r("system","Progress saved to JSON file");const e=JSON.stringify(s,null,2),t=new Blob([e],{type:"application/json"}),n=document.createElement("a");n.href=URL.createObjectURL(t),n.download=`${s.studentId}_${s.name}_progress.json`,n.click(),URL.revokeObjectURL(n.href)}),function(r=""){const o=localStorage.getItem(n+r);if(o)try{const n=JSON.parse(o);s.studentId=n.studentId||"",s.name=n.name||"",g&&(g.value=s.studentId),y&&(y.value=s.name),Array.isArray(n.logs)&&(s.logs=n.logs),n.answers&&(s.answers=n.answers,Object.keys(n.answers).forEach(s=>{const r=parseInt(s,10),o=n.answers[r];if(!o||!o.isCorrect)return;const a=document.querySelector(`.problem-container[data-index="${r}"]`);if(a){const n=a.querySelector(".student-input, .essay-student-input"),s=a.querySelector(".check-btn, .essay-submit-btn"),i=a.querySelector(".result-msg"),c=a.getAttribute("data-type")||"quiz",l=t[r];if(n&&s&&i)if(n.value=o.userAnswer,n.disabled=!0,s.disabled=!0,"essay"===c)i.innerHTML='<span style="color:green">記録しました</span>',s.textContent="記録済み",u(r,"(記述済み)");else if("quiz"===c){const t=e(l.encryptedText);i.innerHTML=`<span style="color:blue">正解! (${t})</span>`,u(r,t)}}}))}catch(a){console.error("Restore failed",a)}}(),a(),r("system","System Loaded/Restored")})}();
