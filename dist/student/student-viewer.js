!function(){"use strict";document.addEventListener("DOMContentLoaded",function(){const e=window.PROBLEM_DATA_LIST;if(!e)return;const t={studentId:"",name:"",answers:{},logs:[],savedAt:""};function n(e,n,s){const o={timestamp:(new Date).toISOString(),type:e,message:n,details:s};t.logs.push(o),console.log(`[${o.timestamp}] [${e}] ${n}`,s||"")}function s(){const e=document.querySelectorAll(".problem-container");let n=!1;e.forEach((e,s)=>{var r;const i=e;if(n)return i.classList.add("is-locked"),void o(i);const c=!0===(null==(r=t.answers[s])?void 0:r.isCorrect);i.classList.remove("is-locked"),c?function(e){let t=e.nextElementSibling;for(;t&&!t.classList.contains("problem-container")&&"save-area"!==t.id&&!t.classList.contains("app-footer");)t.classList.remove("is-locked"),t=t.nextElementSibling}(i):(n=!0,o(i))});const s=document.getElementById("save-area");s&&(n?s.classList.add("is-locked"):s.classList.remove("is-locked"))}function o(e){let t=e.nextElementSibling;for(;t;)"save-area"===t.id||t.classList.contains("app-footer")||t.classList.add("is-locked"),t=t.nextElementSibling}n("system","System Initialized",{problemCount:e.length});const r=document.getElementById("answer-drawer"),i=document.getElementById("drawer-toggle"),c=document.getElementById("drawer-list");i&&r&&i.addEventListener("click",()=>{r.classList.toggle("open")?(document.body.classList.add("drawer-open"),i.textContent="▶ 閉じる"):(document.body.classList.remove("drawer-open"),i.textContent="◀ 解答")}),document.querySelectorAll(".problem-container").forEach(o=>{const r=o.getAttribute("data-index");if(null===r)return;const i=parseInt(r,10),a=e[i],l=o.querySelector(".student-input"),d=o.querySelector(".check-btn"),m=o.querySelector(".result-msg");l&&d&&m&&d.addEventListener("click",()=>{const e=l.value.trim(),o=function(e){let t=2166136261;for(let n=0;n<e.length;n++)t^=e.charCodeAt(n),t=Math.imul(t,16777619);return(t>>>0).toString(16)}(e),r=-1!==a.correctHashes.indexOf(o);if(n("answer",`Question ${i+1} attempt`,{input:e,isCorrect:r}),r){const n=function(e,t=66){try{const n=atob(e);let s="";for(let e=0;e<n.length;e++)s+=String.fromCharCode(n.charCodeAt(e)^t);return decodeURIComponent(s)}catch(n){return console.error("Decryption failed:",n),"Decryption Error"}}(a.encryptedText);m.innerHTML=`<span style="color:blue">正解! (${n})</span>`,l.disabled=!0,d.disabled=!0,t.answers[i]={userAnswer:e,isCorrect:!0,timestamp:(new Date).toISOString()},function(e,t){if(!c)return;const n=document.querySelectorAll(".problem-container")[e];let s=`Q${e+1}`;if(n){const e=n.querySelector(".question-content");e&&e.textContent&&(s=e.textContent.substring(0,20)+(e.textContent.length>20?"...":""))}const o=document.createElement("div");o.className="drawer-item",o.innerHTML=`\n        <div class="drawer-item-q">${s}</div>\n        <div class="drawer-item-a">${t}</div>\n      `,c.appendChild(o),c.scrollTop=c.scrollHeight}(i,n),s()}else m.innerHTML='<span style="color:red">不正解</span>',t.answers[i]={userAnswer:e,isCorrect:!1,timestamp:(new Date).toISOString()}})});const a=document.getElementById("save-btn"),l=document.getElementById("student-id"),d=document.getElementById("student-name");a&&l&&d&&a.addEventListener("click",()=>{if(t.studentId=l.value,t.name=d.value,t.savedAt=(new Date).toISOString(),!t.studentId||!t.name)return alert("学籍番号と氏名を入力してください"),void n("error","Save attempt failed: Missing ID or Name");n("system","Progress saved to JSON file");const e=JSON.stringify(t,null,2),s=new Blob([e],{type:"application/json"}),o=document.createElement("a");o.href=URL.createObjectURL(s),o.download=`${t.studentId}_${t.name}_progress.json`,o.click(),URL.revokeObjectURL(o.href)}),s()})}();
