!function(){"use strict";function e(e,t=66){try{const n=atob(e);let s="";for(let e=0;e<n.length;e++)s+=String.fromCharCode(n.charCodeAt(e)^t);return decodeURIComponent(s)}catch(n){return console.error("Decryption failed:",n),"Decryption Error"}}document.addEventListener("DOMContentLoaded",function(){const t=window.PROBLEM_DATA_LIST;if(!t)return;const n=`rny_student_progress_${(window.LECTURE_TITLE||"default").replace(/[\s\/:*?"<>|]/g,"_")}`,s={studentId:"",name:"",answers:{},logs:[],savedAt:""},r=document.getElementById("answer-drawer"),o=document.getElementById("drawer-toggle"),a=document.getElementById("drawer-list"),i=document.getElementById("save-btn"),l=document.getElementById("student-id"),d=document.getElementById("student-name"),c=document.createElement("div");function u(e,t,n,r){const o={timestamp:(new Date).toISOString(),type:e,message:n,details:r};!function(e){const t=[`[${e.timestamp}] [${e.type}] ${e.message}`,e.details||""];"info"===e.type?console.info(...t):"warn"===e.type?console.warn(...t):"error"===e.type?console.error(...t):console.log(...t)}(o),t&&s.logs.push(o)}function m(){try{u("debug",!1,"CALL::saveToStorage()"),localStorage.setItem(n,JSON.stringify(s))}catch(e){console.warn("LocalStorage save failed",e)}}function p(){const e=t.length,n=Object.values(s.answers).filter(e=>e&&(e.isCorrect||e.isSkipped)).length;c.textContent=`完了: ${n} / ${e}`,n===e&&(c.style.backgroundColor="rgba(40, 167, 69, 0.9)",c.textContent+=" (All Clear!)")}function g(){u("debug",!1,"CALL::updateGateVisibility()");const e=document.getElementById("main-content");if(!e)return void u("error",!0," #main-content が見つかりません");const t=Array.from(e.children);let n=!0,r=!0;t.forEach(e=>{u("debug",!1,"要素:",e);const t=e.querySelector(".problem-container");if("save-area"===e.id||e.classList.contains("app-footer"))u("debug",!1,"この要素は save-area または app-footer",e);else if(n){if(e.classList.remove("is-locked"),t){const e=t.getAttribute("data-index");if(null!==e){u("debug",!1,`問題番号${e}`);const t=parseInt(e,10),o=s.answers[t];!0===(null==o?void 0:o.isCorrect)||!0===(null==o?void 0:o.isSkipped)||(n=!1,r=!1)}else u("debug",!1,"問題の indexStr が null")}}else e.classList.add("is-locked")});const o=document.getElementById("status-msg");o&&(o.innerHTML="続きがあります",r&&(o.innerHTML="資料は終わりです"));const a=document.getElementById("save-area");a&&a.classList.remove("is-locked")}function y(e,t){if(!a)return;if(document.getElementById(`log-ans-${e}`))return;const n=document.querySelectorAll(".problem-container")[e];let s=`Q:${e+1}`;if(n){const e=n.querySelector(".question-content");e&&e.textContent&&(s=e.textContent.substring(0,40)+(e.textContent.length>40?"...":""))}const r=document.createElement("div");r&&(r.className="drawer-item",r.id=`log-ans-${e}`,r.innerHTML=`\n        <div class="drawer-item-q">${s}</div>\n        <div class="drawer-item-a">${t}</div>\n      `,a.appendChild(r)),a.scrollTop=a.scrollHeight}c.className="progress-float",document.body.appendChild(c),function(){u("system",!1,"CALL::restoreProgress()");const r=localStorage.getItem(n);if(u("debug",!1,"データ復元中..."),r)try{const n=JSON.parse(r);s.studentId=n.studentId||"",s.name=n.name||"",l&&(l.value=s.studentId),d&&(d.value=s.name),Array.isArray(n.logs)&&(s.logs=n.logs,u("system",!0,"ログを復元",...s.logs)),n.answers||u("info",!1,"答えのデータ：なし"),n.answers&&(s.answers=n.answers,u("info",!1,"回答状況の復元:",n.answers),Object.keys(n.answers).forEach(s=>{const r=parseInt(s,10),o=n.answers[r];if(!o||!o.isCorrect&&!o.isSkipped)return;const a=document.querySelector(`.problem-container[data-index="${r}"]`);if(a){const n=a.querySelector(".student-input, .essay-student-input"),s=a.querySelector(".check-btn, .essay-submit-btn"),i=a.querySelector(".result-msg"),l=a.getAttribute("data-type")||"quiz",d=t[r];if(n&&s&&i||(n||console.error("input(.student-input, .essay-student-input) が見つかりません"),s||console.error("btn(.check-btn, .essay-submit-btn) が見つかりません"),i||console.error("msg(.result-msg) が見つかりません")),n&&s&&i)if(n.value=o.userAnswer,n.disabled=!0,s.disabled=!0,"essay"===l)i.innerHTML='<span style="color:green">保存済み</span>',s.textContent="保存済み",n.disabled=!1,s.disabled=!1,y(r,"(記述済み)");else if("quiz"===l){const t=e(d.encryptedText);o.isCorrect?i.innerHTML=`<span style="color:blue">正解! (${t})</span>`:i.innerHTML='<span style="color:orange">(スキップ)</span>',n.disabled=!0,s.disabled=!0,y(r,t)}}}))}catch(o){u("error",!1,"Restore failed",o)}else u("info",!1,"保存されたデータ：なし")}(),u("system",!0,"Logging System Initialized",{problemCount:t.length}),o&&r&&o.addEventListener("click",()=>{r.classList.toggle("open")?(document.body.classList.add("drawer-open"),o.textContent="▶ 閉じる"):(document.body.classList.remove("drawer-open"),o.textContent="◀ 解答")});let b,f=0;c.addEventListener("click",()=>{f++,clearTimeout(b),b=setTimeout(()=>{f=0},2e3),f>=7&&(confirm("【管理者機能】\n学習履歴（進捗データ）を削除しますか？\nページはリロードされます。")&&(localStorage.removeItem(n),alert("削除しました。"),location.reload()),f=0)}),document.querySelectorAll(".problem-container").forEach(n=>{const r=n.getAttribute("data-index");if(null===r)return;const o=parseInt(r,10),a=t[o],i=n.getAttribute("data-type"),l=n.querySelector(".student-input, .essay-student-input"),d=n.querySelector(".check-btn, .essay-submit-btn"),c=n.querySelector(".result-msg"),b=n.querySelector(".skip-btn");if(!l||!d||!c)return l||console.error("input(.student-input, .essay-student-input) が見つかりません"),d||console.error("btn(.check-btn, .essay-submit-btn) が見つかりません"),void(c||console.error("msg(.result-msg) が見つかりません"));"essay"===i&&l.addEventListener("input",()=>{d.disabled=!1,d.textContent="保存する（未保存）",d.style.backgroundColor="#d9534f",c.innerHTML=""}),b&&b.addEventListener("click",()=>{confirm("この問題をスキップしますか？\n（正解扱いにはなりません）")&&(c.innerHTML='<span style="color:orange">スキップしました</span>',l.value="(スキップ)",l.disabled=!0,d.disabled=!0,b.disabled=!0,s.answers[o]={userAnswer:"(SKIPPED)",isCorrect:!1,isSkipped:!0,timestamp:(new Date).toISOString()},u("answer",!0,`Question ${o+1} skipped`),y(o,"(スキップ)"),g(),p(),m())});const f=(t,n=!1)=>{if("essay"===i){if(!n&&0===t.length)return void alert("内容を入力してください");c.innerHTML='<span style="color:green">記録しました</span>',l.disabled=!1,d.disabled=!1,d.style.backgroundColor="",d.textContent="記録済み",n||(s.answers[o]={userAnswer:t,isCorrect:!0,timestamp:(new Date).toISOString(),isSkipped:!1},y(o,"(記述済み)"),u("answer",!0,`Essay ${o+1} submitted/updated`),g(),p())}else{const r=function(e){let t=2166136261;for(let n=0;n<e.length;n++)t^=e.charCodeAt(n),t=Math.imul(t,16777619);return(t>>>0).toString(16)}(t),i=-1!==a.correctHashes.indexOf(r);if(n||u("answer",!0,`Question ${o+1} attempt`,{isCorrect:i}),i){const r=e(a.encryptedText);c.innerHTML=`<span style="color:blue">正解! (${r})</span>`,l.disabled=!0,d.disabled=!0,b.disabled=!0,n||(s.answers[o]={userAnswer:t,isCorrect:!0,timestamp:(new Date).toISOString(),isSkipped:!1},y(o,r),g(),p())}else c.innerHTML='<span style="color:red">不正解</span>',n||(s.answers[o]={userAnswer:t,isCorrect:!1,timestamp:(new Date).toISOString(),isSkipped:!1})}m()};if("input"===l.tagName){l.addEventListener("keydown",e=>{e.isComposing||"Enter"===e.key&&(e.preventDefault(),f(l.value.trim()))})}d.addEventListener("click",()=>{f(l.value.trim())})}),i&&l&&d&&i.addEventListener("click",()=>{if(s.studentId=l.value,s.name=d.value,s.savedAt=(new Date).toISOString(),!s.studentId||!s.name)return alert("学籍番号と氏名を入力してください"),u("error",!0,"Save attempt failed: Missing ID or Name"),void m();u("system",!0,"Progress saved to JSON file"),m();const e=JSON.stringify(s,null,2),t=new Blob([e],{type:"application/json"}),n=document.createElement("a");n.href=URL.createObjectURL(t),n.download=`${s.studentId}_${s.name}_progress.json`,n.click(),URL.revokeObjectURL(n.href)}),g(),p(),u("system",!0,"System Loaded")})}();
