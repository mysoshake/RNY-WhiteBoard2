!function(){"use strict";function e(e,t=66){const n=function(e){const t=Uint8Array.from(Array.from(atob(e)).map(e=>e.charCodeAt(0)));return(new TextDecoder).decode(t)}(e);let s="";for(let o=0;o<n.length;o++)s+=String.fromCharCode(n.charCodeAt(o)^t);return s}document.addEventListener("DOMContentLoaded",function(){const t=window.PROBLEM_DATA_LIST;if(!t)return;const n={studentId:"",name:"",answers:{},logs:[],savedAt:""};function s(e,t,s){const o={timestamp:(new Date).toISOString(),type:e,message:t,details:s};n.logs.push(o),console.log(`[${o.timestamp}] [${e}] ${t}`,s||"")}function o(){const e=document.querySelectorAll(".problem-container");let t=!1;e.forEach((e,s)=>{var o;const i=e;if(t)return i.classList.add("is-locked"),void r(i);const a=!0===(null==(o=n.answers[s])?void 0:o.isCorrect);i.classList.remove("is-locked"),a?function(e){let t=e.nextElementSibling;for(;t&&!t.classList.contains("problem-container")&&"save-area"!==t.id&&!t.classList.contains("app-footer");)t.classList.remove("is-locked"),t=t.nextElementSibling}(i):(t=!0,r(i))});const s=document.getElementById("save-area");s&&(t?s.classList.add("is-locked"):s.classList.remove("is-locked"))}function r(e){let t=e.nextElementSibling;for(;t;)"save-area"===t.id||t.classList.contains("app-footer")||t.classList.add("is-locked"),t=t.nextElementSibling}s("system","System Initialized",{problemCount:t.length});const i=document.getElementById("answer-drawer"),a=document.getElementById("drawer-toggle"),c=document.getElementById("drawer-list");i&&a&&a.addEventListener("click",()=>{const e=!i.classList.contains("open");i.classList.toggle("open"),a.textContent=e?"▶ 閉じる":"◀ 解答",s("info","Drawer toggled: "+(e?"OPEN":"CLOSE"))}),document.querySelectorAll(".problem-container").forEach(r=>{const i=r.getAttribute("data-index");if(null===i)return;const a=parseInt(i,10),l=t[a],d=r.querySelector(".student-input"),m=r.querySelector(".check-btn"),u=r.querySelector(".result-msg");d&&m&&u&&m.addEventListener("click",()=>{const t=d.value.trim(),r=function(e){let t=2166136261;for(let n=0;n<e.length;n++)t^=e.charCodeAt(n),t=Math.imul(t,16777619);return(t>>>0).toString(16)}(t),i=-1!==l.correctHashes.indexOf(r);if(s("answer",`Question ${a+1} attempt`,{input:t,isCorrect:i}),i){const s=e(l.encryptedText);u.innerHTML=`<span style="color:blue">正解! (${s})</span>`,d.disabled=!0,m.disabled=!0,n.answers[a]={userAnswer:t,isCorrect:!0,timestamp:(new Date).toISOString()},function(e,t){if(!c)return;const n=document.querySelectorAll(".problem-container")[e];let s=`Q${e+1}`;if(n){const e=n.querySelector(".question-content");e&&e.textContent&&(s=e.textContent.substring(0,20)+(e.textContent.length>20?"...":""))}const o=document.createElement("div");o.className="drawer-item",o.innerHTML=`\n        <div class="drawer-item-q">${s}</div>\n        <div class="drawer-item-a">${t}</div>\n      `,c.appendChild(o),c.scrollTop=c.scrollHeight}(a,s),o()}else u.innerHTML='<span style="color:red">不正解</span>',n.answers[a]={userAnswer:t,isCorrect:!1,timestamp:(new Date).toISOString()}})});const l=document.getElementById("save-btn"),d=document.getElementById("student-id"),m=document.getElementById("student-name");l&&d&&m&&l.addEventListener("click",()=>{if(n.studentId=d.value,n.name=m.value,n.savedAt=(new Date).toISOString(),!n.studentId||!n.name)return alert("学籍番号と氏名を入力してください"),void s("error","Save attempt failed: Missing ID or Name");s("system","Progress saved to JSON file");const e=JSON.stringify(n,null,2),t=new Blob([e],{type:"application/json"}),o=document.createElement("a");o.href=URL.createObjectURL(t),o.download=`${n.studentId}_${n.name}_progress.json`,o.click(),URL.revokeObjectURL(o.href)}),o()})}();
