!function(){"use strict";function e(e,t=66){try{const n=atob(e);let s="";for(let e=0;e<n.length;e++)s+=String.fromCharCode(n.charCodeAt(e)^t);return decodeURIComponent(s)}catch(n){return console.error("Decryption failed:",n),"Decryption Error"}}document.addEventListener("DOMContentLoaded",function(){const t=window.PROBLEM_DATA_LIST;if(!t)return;const n="rny_student_progress_",s={studentId:"",name:"",answers:{},logs:[],savedAt:""};function r(e,t,n){const r={timestamp:(new Date).toISOString(),type:e,message:t,details:n};s.logs.push(r),console.log(`[${r.timestamp}] [${e}] ${t}`,n||"")}function o(){const e=document.getElementById("main-content");if(!e)return;const t=Array.from(e.children);let n=!0;t.forEach(e=>{var t;if("save-area"!==e.id&&!e.classList.contains("app-footer"))if(n){if(e.classList.remove("is-locked"),e.classList.contains("problem-container")){const r=e.getAttribute("data-index");if(null!==r){const e=parseInt(r,10);!0===(null==(t=s.answers[e])?void 0:t.isCorrect)||(n=!1)}}}else e.classList.add("is-locked")});const r=document.getElementById("save-area");r&&r.classList.remove("is-locked")}r("system","System Initialized",{problemCount:t.length});const a=document.getElementById("answer-drawer"),i=document.getElementById("drawer-toggle"),l=document.getElementById("drawer-list");function c(e,t){if(!l)return;if(document.getElementById(`log-ans-${e}`))return;const n=document.querySelectorAll(".problem-container")[e];let s=`Q:${e+1}`;if(n){const e=n.querySelector(".question-content");e&&e.textContent&&(s=e.textContent.substring(0,40)+(e.textContent.length>40?"...":""))}const r=document.createElement("div");r&&(r.className="drawer-item",r.id=`log-ans-${e}`,r.innerHTML=`\n        <div class="drawer-item-q">${s}</div>\n        <div class="drawer-item-a">${t}</div>\n      `,l.appendChild(r)),l.scrollTop=l.scrollHeight}i&&a&&i.addEventListener("click",()=>{a.classList.toggle("open")?(document.body.classList.add("drawer-open"),i.textContent="▶ 閉じる"):(document.body.classList.remove("drawer-open"),i.textContent="◀ 解答")}),document.querySelectorAll(".problem-container").forEach(a=>{const i=a.getAttribute("data-index");if(null===i)return;const l=parseInt(i,10),d=t[l],u=a.getAttribute("data-type"),m=a.querySelector(".student-input, .essay-student-input"),y=a.querySelector(".check-btn, .essay-submit-btn"),g=a.querySelector(".result-msg");if(!m||!y||!g)return m||console.error("input(.student-input, .essay-student-input) が見つかりません"),y||console.error("btn(.check-btn, .essay-submit-btn) が見つかりません"),void(g||console.error("msg(.result-msg) が見つかりません"));"essay"===u&&m.addEventListener("input",()=>{y.disabled=!1,y.textContent="保存する（未保存）",y.style.backgroundColor="#d9534f",g.innerHTML=""});const p=(t,a=!1)=>{if("essay"===u){if(!a&&0===t.length)return void alert("内容を入力してください");g.innerHTML='<span style="color:green">記録しました</span>',m.disabled=!1,y.disabled=!1,y.style.backgroundColor="",y.textContent="記録済み",a||(s.answers[l]={userAnswer:t,isCorrect:!0,timestamp:(new Date).toISOString()},r("answer",`Essay ${l+1} submitted/updated`),c(l,"(記述済み)"),o())}else{const n=function(e){let t=2166136261;for(let n=0;n<e.length;n++)t^=e.charCodeAt(n),t=Math.imul(t,16777619);return(t>>>0).toString(16)}(t),i=-1!==d.correctHashes.indexOf(n);if(a||r("answer",`Question ${l+1} attempt`,{isCorrect:i}),i){const n=e(d.encryptedText);g.innerHTML=`<span style="color:blue">正解! (${n})</span>`,m.disabled=!0,y.disabled=!0,a||(s.answers[l]={userAnswer:t,isCorrect:!0,timestamp:(new Date).toISOString()},c(l,n),o())}else g.innerHTML='<span style="color:red">不正解</span>',a||(s.answers[l]={userAnswer:t,isCorrect:!1,timestamp:(new Date).toISOString()})}!function(e=""){try{r("system","saveToStorage",`id=${e}`),localStorage.setItem(n+e,JSON.stringify(s))}catch(t){console.warn("LocalStorage save failed",t)}}()};y.addEventListener("click",()=>{p(m.value.trim())})});const d=document.getElementById("save-btn"),u=document.getElementById("student-id"),m=document.getElementById("student-name");d&&u&&m&&d.addEventListener("click",()=>{if(s.studentId=u.value,s.name=m.value,s.savedAt=(new Date).toISOString(),!s.studentId||!s.name)return alert("学籍番号と氏名を入力してください"),void r("error","Save attempt failed: Missing ID or Name");r("system","Progress saved to JSON file");const e=JSON.stringify(s,null,2),t=new Blob([e],{type:"application/json"}),n=document.createElement("a");n.href=URL.createObjectURL(t),n.download=`${s.studentId}_${s.name}_progress.json`,n.click(),URL.revokeObjectURL(n.href)}),function(o=""){const a=localStorage.getItem(n+o);if(console.log("データ復元中..."),a)try{const n=JSON.parse(a);s.studentId=n.studentId||"",s.name=n.name||"",u&&(u.value=s.studentId),m&&(m.value=s.name),Array.isArray(n.logs)&&(s.logs=n.logs,r("system","ログを復元",...s.logs)),n.answers||console.info("答えのデータ: なし"),n.answers&&(s.answers=n.answers,console.info("回答状況の復元:",n.answers),Object.keys(n.answers).forEach(s=>{const r=parseInt(s,10),o=n.answers[r];if(!o||!o.isCorrect)return;const a=document.querySelector(`.problem-container[data-index="${r}"]`);if(a){const n=a.querySelector(".student-input, .essay-student-input"),s=a.querySelector(".check-btn, .essay-submit-btn"),i=a.querySelector(".result-msg"),l=a.getAttribute("data-type")||"quiz",d=t[r];if(n&&s&&i||(n||console.error("input(.student-input, .essay-student-input) が見つかりません"),s||console.error("btn(.check-btn, .essay-submit-btn) が見つかりません"),i||console.error("msg(.result-msg) が見つかりません")),n&&s&&i)if(n.value=o.userAnswer,n.disabled=!0,s.disabled=!0,"essay"===l)i.innerHTML='<span style="color:green">保存済み</span>',s.textContent="保存済み",n.disabled=!1,s.disabled=!1,c(r,"(記述済み)");else if("quiz"===l){const t=e(d.encryptedText);i.innerHTML=`<span style="color:blue">正解! (${t})</span>`,n.disabled=!0,s.disabled=!0,c(r,t)}}}))}catch(i){console.error("Restore failed",i)}else console.info("保存されたデータ：なし")}(),o(),r("system","System Loaded/Restored")})}();
