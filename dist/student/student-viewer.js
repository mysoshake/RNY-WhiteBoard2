!function(){"use strict";document.addEventListener("DOMContentLoaded",function(){const e=window.PROBLEM_DATA_LIST;if(!e)return;const t={studentId:"",name:"",answers:{},logs:[],savedAt:""};function n(e,n,s){const r={timestamp:(new Date).toISOString(),type:e,message:n,details:s};t.logs.push(r),console.log(`[${r.timestamp}] [${e}] ${n}`,s||"")}function s(){const e=document.querySelectorAll(".problem-container");let n=!1;e.forEach((e,s)=>{var o;const i=e;if(n)return i.classList.add("is-locked"),void r(i);const a=!0===(null==(o=t.answers[s])?void 0:o.isCorrect);i.classList.remove("is-locked"),a?function(e){let t=e.nextElementSibling;for(;t&&!t.classList.contains("problem-container")&&"save-area"!==t.id&&!t.classList.contains("app-footer");)t.classList.remove("is-locked"),t=t.nextElementSibling}(i):(n=!0,r(i))});const s=document.getElementById("save-area");s&&(n?s.classList.add("is-locked"):s.classList.remove("is-locked"))}function r(e){let t=e.nextElementSibling;for(;t;)"save-area"===t.id||t.classList.contains("app-footer")||t.classList.add("is-locked"),t=t.nextElementSibling}n("system","System Initialized",{problemCount:e.length});const o=document.getElementById("answer-drawer"),i=document.getElementById("drawer-toggle"),a=document.getElementById("drawer-list");function c(e,t){if(!a)return;const n=document.querySelectorAll(".problem-container")[e];let s=`Q${e+1}`;if(n){const e=n.querySelector(".question-content");e&&e.textContent&&(s=e.textContent.substring(0,20)+(e.textContent.length>20?"...":""))}const r=document.createElement("div");r.className="drawer-item",r.innerHTML=`\n        <div class="drawer-item-q">${s}</div>\n        <div class="drawer-item-a">${t}</div>\n      `,a.appendChild(r),a.scrollTop=a.scrollHeight}i&&o&&i.addEventListener("click",()=>{o.classList.toggle("open")?(document.body.classList.add("drawer-open"),i.textContent="▶ 閉じる"):(document.body.classList.remove("drawer-open"),i.textContent="◀ 解答")}),document.querySelectorAll(".problem-container").forEach(r=>{const o=r.getAttribute("data-index");if(null===o)return;const i=parseInt(o,10),a=e[i],l=r.getAttribute("data-type"),d=r.querySelector(".student-input, .student-essay-input"),u=r.querySelector(".check-btn"),m=r.querySelector(".result-msg");d&&u&&m&&l&&u.addEventListener("click",()=>{const e=d.value.trim(),r=function(e){let t=2166136261;for(let n=0;n<e.length;n++)t^=e.charCodeAt(n),t=Math.imul(t,16777619);return(t>>>0).toString(16)}(e),o=-1!==a.correctHashes.indexOf(r);if("essay"===l)return 0===e.length?void alert("内容を入力してください"):(m.innerHTML='<span style="color:green">記録しました</span>',d.disabled=!0,u.disabled=!0,u.textContent="記録済み",n("answer",`Essay ${i+1} submitted`,{input:e}),t.answers[i]={userAnswer:e,isCorrect:!0,timestamp:(new Date).toISOString()},c(i,"(記述済み)"),void s());if(n("answer",`Question ${i+1} attempt`,{input:e,isCorrect:o}),o){const n=function(e,t=66){try{const n=atob(e);let s="";for(let e=0;e<n.length;e++)s+=String.fromCharCode(n.charCodeAt(e)^t);return decodeURIComponent(s)}catch(n){return console.error("Decryption failed:",n),"Decryption Error"}}(a.encryptedText);m.innerHTML=`<span style="color:blue">正解! (${n})</span>`,d.disabled=!0,u.disabled=!0,t.answers[i]={userAnswer:e,isCorrect:!0,timestamp:(new Date).toISOString()},c(i,n),s()}else m.innerHTML='<span style="color:red">不正解</span>',t.answers[i]={userAnswer:e,isCorrect:!1,timestamp:(new Date).toISOString()}})});const l=document.getElementById("save-btn"),d=document.getElementById("student-id"),u=document.getElementById("student-name");l&&d&&u&&l.addEventListener("click",()=>{if(t.studentId=d.value,t.name=u.value,t.savedAt=(new Date).toISOString(),!t.studentId||!t.name)return alert("学籍番号と氏名を入力してください"),void n("error","Save attempt failed: Missing ID or Name");n("system","Progress saved to JSON file");const e=JSON.stringify(t,null,2),s=new Blob([e],{type:"application/json"}),r=document.createElement("a");r.href=URL.createObjectURL(s),r.download=`${t.studentId}_${t.name}_progress.json`,r.click(),URL.revokeObjectURL(r.href)}),s()})}();
